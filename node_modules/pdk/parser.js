var G=global,X=exports,
   pops=require('pops/pops.loader.js').Load({}),

   GetArgs=X.GetArgs=function(s,ls,pos){
      var z,rv=[];
      while(pos<s.length){
         z=NextArg(s,ls,pos);
         eval($Back('z'));
         if(z.val.typ!='none')rv.push(z.val);
      };
      return RVal(s,ls,pos,rv);
   },
   GetUntil=X.GetUntil=function(s,ls,pos,str,caseSensative){
      var cs=caseSensative,p=pos,c,cc,rv='',
         st=cs?str:str.LCase()
      ;
      while(p<s.length&&cc!=st){
         c=s.charAt(p);
         cc=cs?c.LCase():c;
         if(cc!=st)rv+=cc;
         p++;
      };
      return RVal(s,ls,p,rv);
   },
   NextArg=X.NextArg=function(s,ls,pos){
      var z=' ',tt='txt',vv='',zz;
      
      while(z==' '&&pos<s.length){
         z=s.charAt(pos);pos++;
         if(z==' ')vv+=z;
      };
      
      if(z=='{'){
         tt='obj'
      }
      else{
         if(z!=' ')vv+=z;
         if(pos<s.length){
            zz=GetUntil(s,ls,pos,',');
            eval($Back('zz'));
            vv+=zz.val;
         };
      };

      tt=vv.Trim()==''?'none':tt;
      return RVal(s,ls,pos,{typ:tt,val:vv});
   },
   RVal=X.RVal=function(s,ls,pos,val){
      return{s:s?s:'',ls:ls?ls:'',pos:pos?pos:0,val:val?val:null};
   },
   $Back=function(n){return's='+n+'.s;ls='+n+'.ls;pos='+n+'.pos;';},

   cmd=G.cmd=X.cmd=new Class({
      Private:({$Back:$Back,GetArgs:GetArgs,GetUntil:GetUntil,NextArg:NextArg,RVal:RVal}),
      Init:function(str){
         var t=this,z;
         t.args=[];
         t.S=t.s=str.Trim();t.ls=t.s.LCase();
         t.pos=0;
         
         if(t.ls.length){
            t.$$Main();
            z=t.typ;
            if(0){}
            else if(z=='cmd'){
               
            }
            else if(z=='js'){
               
            }
         };
      },
      $$Main:function(){
         var t=this,z=t.GetSymbol(),zz=[],v,vv,tp;
         
         if(z.typ=='op'){
            if(z.val=='`'){
               t.typ='js';
               t.val=t.S.substr(t.pos,t.S.length-t.pos);
               //cout('t.val= '+t.val);
            }
            else{t.err=2;t.errMsg='bad command(op)';};
         }
         else if(z.typ=='txt'){
            t.typ='cmd';t.nam=z.val;
            vv=GetArgs(t.s,t.ls,t.pos);
            t.args=vv.val;t.s=t.S=vv.s;t.ls=vv.ls;t.pos=vv.pos;
            
         }
         else{t.err=2;t.errMsg='bad command';};
      },
      GetSymbol:function(){
         var t=this,S=t.S,ls=t.ls,ya=2,z,p=t.pos,ln=t.ls.length,v='',tp='no';
         
         while(p<ln&&ya){
            z=ls.charAt(p);
            p++;
            if(z==' '){
               if(v.length)ya=0;
               else t.Skip(' ');
            }
            else if(z=='`'||z=='<'||z=='>'||z=='{'||z=='}'||z=='\\'||z=='/'||z=='.'||z==$cr){
               if(v.length){p--;ya=0;}
               else{v=z;tp='op';ya=0;};
            }
            else{v+=z;tp='txt';};
         };
         
         t.pos=p;
         return {typ:tp,val:v};
      },
   
      Skip:function(chr){
         var t=this,ls=t.ls,ya=2,z,p=t.pos,ln=t.ls.length;
         while(p<ln&&ya){
            z=ls.charAt(p);
            if(z==chr)p++;
            else ya=0;
         };
         t.pos=p;
      },
      GetUntil:function(str,caseSensative){
         var t=this,cs=caseSensative,ya=2,z,p=t.pos,ln=t.ls.length,c,rv='',
            s=cs?str:str.LCase(),ls=cs?t.S:t.ls
         ;
         while(p<ln&&c!=chr){
            p++;
            c=ls.charAt(p);
            if(c!=s)rv+=c;
         };
         t.pos=p;
         return rv;
      },
      NextArg:function(){},
   })




;

