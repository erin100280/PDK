console.log('\n\n====================================================================\n  PDS 0.2 (c)2012 Erin Bradford.\n');
var pops=require('pops/pops.loader.js').Load({
   //root:$root+'App/system/pops/'
});

if(2){//init vars
   var G=global,ls,curID=0,$glb={},
      $cr='\n',
      $args=G.$args=process.argv,
      $DIR=G.$DIR=$args[0].split('\\\\')[0],
      $dir=G.$dir=$DIR+'\\',
      $iq=G.$iq=[],
      $mq=G.$mq=[],
      $sq=G.$sq=[],

      jse=require('pdk/JSEnv.js'),
      prsr=require('pdk/parser.js'),

      cGen=require('pdk/cmdGeneral.js'),
      cPops=require('pdk/cmdPops.js'),
      cPopsLast=require('pdk/cmdPopsLast.js')
   ;
};

if(2){//-Functions [$$DoMain(),DoMain(),Input(),MainDat(),OnDat(),OnData()]
   var z,
      OnDat=0,
      OnData=function(S){
         process.stdin.pause();
         var z,
            cm=new prsr.cmd(S),
            s=S.TrimCR(),
            ls=s.toLowerCase()
         ;
         cout('here');
         //console.dir(cm);
         if(OnDat)OnDat(cm,S,s,ls);
      },
      Input=G.Input=function(msg,fn){
         if(!IsStr(msg))msg='PDS';
         OnDat=fn;
         sout(msg+'> ');
         process.stdin.resume();
      },
      MainDat=G.MainDat=function(cm,S,s,ls){
         var tp=cm.typ,nm=cm.nam?cm.nam:'??';
         if(!cm.ls.length)DoMain();
         else{
            if(tp=='cmd'){
               cout('CMD');
               if(0){}
               else if(cGen.DoCmd(cm,S,s,ls)){}
               else if(cPops.DoCmd(cm)){}
               else if(cPopsLast.DoCmd(cm)){}
               else{cout(' -- Unknown Command: '+nm+'\n');DoMain()}; 
            }
            else if(tp=='js'){/*cout('            JS');*/jse.RunJS(cm.val);DoMain();}
            else{cout(' -- Unknown Command: '+nm+'\n');DoMain()};
         };
      },
      DoMain=G.DoMain=function(){$$DoMain.aCall();},
      $$DoMain=function(){Input('PDS|'+process.cwd(),MainDat);}
   ;
};

if(2){//- input queue, msg queue, storage queue.
   var z,
      AddInput=G.AddInput=function(prmpt,msg,fn){
         var p=prmpt,m=msg,f=fn,z=this.z,be=z?$iq.PushB:$iq.PushE;
         if(IsFun(p)){f=p;p=m='';}
         else if(IsFun(m)){f=m;m=''};
         be({p:p?p:'',m:m?m:'',f:f?f:function(){}});
         //else $iq.PushE({p:p?p:'',m:m?m:'',f:f?f:function(){}});
      },
      InsInput=G.InsInput=AddInput.Bind({z:2});
      NextInput=G.NextInput=$iq.PopR()

      AddStore=G.AddStore=function(s){
         s=IsArr(s)?s:[s];
         for(lp=0;lp<s.length;lp++)$sq.PushE(s[lp]);
      },
      InsStore=G.InsStore=function(s){
         s=IsArr(s)?s:[s];
         for(lp=s.length-1;lp>=0;lp--)$sq.PushB(s[lp]);
      },
      NextStore=G.NextStore=$sq.PopB()
   ;
};

process.stdin.setEncoding('utf8');
process.stdin.on('data',OnData);
DoMain();
